name: Build docker images
on:
    push:
        # Publish `master` as Docker `latest` image.
        branches:
            - master
            - scoped-docker-image-test

        # Publish `v1.2.3` tags as releases.
        tags:
            - '*'

jobs:
    publish_images:
        runs-on: ubuntu-latest
        env:
            DOCKER_BUILDKIT: '1'
        steps:
            - uses: actions/checkout@v2

            - name: Build images
              run: |
                  # Strip git ref prefix from version
                  VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

                  # Strip "v" prefix from tag name
                  [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')

                  # Use Docker `latest` tag convention
                  [ "$VERSION" == "master" ] && VERSION=latest

                  # echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u $GITHUB_ACTOR --password-stdin
                  # docker pull docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache || true
                  # docker pull rector/rector || true
                  # docker build . --target rector --cache-from rector/rector --tag rector/rector:$VERSION
                  # docker build . --target rector-secured --cache-from rector/rector --tag rector/rector-secured:$VERSION

                  echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
                  echo ${{ secrets.DOCKER_SECRET }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
                  docker buildx create --name mybuilder --use
                  docker buildx build \
                        --cache-from=ghcr.io/$GITHUB_REPOSITORY:build-cache \
                        --cache-to=type=registry,ref=ghcr.io/$GITHUB_REPOSITORY:build-cache,mode=max,push=true \
                        --target rector \
                        --push \
                        --build-arg PHP_VERSION=7.4 -t mpdude/rector:php7.4 .
                  # docker tag rector-php7.4 docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache && docker push docker.pkg.github.com/$GITHUB_REPOSITORY/build-cache || true

#            - name: Log into registry
#              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
#
#            - name: Push images
#              run: |
#                  docker push --all-tags rector/rector
#                  docker push --all-tags rector/rector-secured
